# /review-pr — Run QA + Guardian Against a Pull Request

> Invoke this skill to review an existing pull request. Checks out the PR branch, spawns QA and Guardian agents, and posts results as a PR comment.

---

## When to Use

- Reviewing a PR from a human contributor
- Reviewing a PR from another tool or CI pipeline
- Running the same QA + Guardian checks used in `/implement-feature` against external changes
- Second opinion on a PR before merging

---

## Phase 1: Load PR Context

Get the PR details:

```bash
# Get PR metadata
gh pr view <number> --json title,body,headRefName,baseRefName,changedFiles,additions,deletions,files

# Get the list of changed files
gh pr diff <number> --name-only
```

Extract:
- PR title and description
- Head branch name (the PR branch)
- Base branch name (target branch)
- List of all changed files
- Additions and deletions count

Read project context:

```
1. {{PROJECT_RULES_FILE}}                                              — Project rules
2. {{ARCHITECTURE_FILE}}                                               — System architecture
3. .claude/prompts/implementing-features/AGENT-SPAWN-TEMPLATES.md      — Spawn templates
4. .claude/prompts/implementing-features/QA-CHECKLIST-TEMPLATE.md      — QA checklist
```

---

## Phase 2: Checkout PR Branch

```bash
# Fetch and checkout the PR branch
gh pr checkout <number>

# Verify we're on the right branch
git branch --show-current
git log --oneline -5
```

---

## Phase 3: Analyze Changed Files

Group changed files by module/directory:

```
Changed Files Analysis:
  src/components/  — 3 files (auth/LoginForm.tsx, auth/SignupForm.tsx, shared/Button.tsx)
  src/services/    — 2 files (auth-service.ts, user-service.ts)
  src/types/       — 1 file (auth-types.ts)
  tests/           — 2 files (auth-service.test.ts, login.test.tsx)

  Total: 8 files changed (+245, -32)
```

Determine which agent roles would be relevant based on file patterns:
- Files in `src/components/` → component-engineer domain
- Files in `src/services/` → service-engineer domain
- Files in `src/types/` → schema-designer domain
- etc.

This context helps QA know which checklist sections to apply.

---

## Phase 4: Spawn QA Reviewer

Spawn a QA Review agent on the PR branch using the QA Review Agent Spawn template from `AGENT-SPAWN-TEMPLATES.md`.

Adapt the template for PR review context:

```
You are a **QA Review Agent** reviewing PR #<number>: "<PR title>".
You are reviewing on branch **<head-branch>**.

This is a PR review, not a workbranch review. Key differences:
- You are reviewing ALL changed files in the PR (not just one task)
- Group your findings by file/module
- Your report will be posted as a PR comment

<... standard QA phased workflow ...>

## Files Changed

<list all changed files with their modules>

## QA Checklist

<auto-fill based on the file types changed — use QA-CHECKLIST-AUTO-FILL-RULES.md>
```

The QA agent:
1. Runs automated checks (lint, typecheck, test, build)
2. Reviews every changed file
3. Traces data flow across changes
4. Produces a QA report

**Do NOT** have QA update docs on this branch — it's not our branch to modify.

---

## Phase 5: Spawn Codebase Guardian

After QA completes, spawn a Codebase Guardian on the PR branch using the Guardian Spawn template from `AGENT-SPAWN-TEMPLATES.md`.

Adapt the template for PR review context:

```
You are the **Codebase Guardian** reviewing PR #<number>: "<PR title>".
You are reviewing on branch **<head-branch>** against base **<base-branch>**.

This is a PR review. Run all 7 structural checks against the changed files.
Your report will be combined with the QA report and posted as a PR comment.

## Files Changed in This PR

<list all changed files>
```

The Guardian:
1. Runs all 7 structural checks
2. Focuses on the changed files and their relationships
3. Produces a Guardian report

**Do NOT** have Guardian fix issues on this branch — it's not our branch to modify.

---

## Phase 6: Combine & Post Results

### Combine Reports

Merge the QA and Guardian reports into a single PR comment:

```markdown
## Automated Review — QA + Guardian

> Generated by `/review-pr` using the create-claude-workflow QA pipeline.

### QA Review

**Verdict**: PASS / FAIL

**Automated Checks**:
- Lint: PASS/FAIL
- Typecheck: PASS/FAIL
- Tests: PASS/FAIL
- Build: PASS/FAIL

**Code Review**: <summary>

**Issues Found**: <count>
<list of issues with file:line references>

---

### Codebase Guardian

**Verdict**: PASS / FAIL

| Check | Result |
|-------|--------|
| File Placement | PASS/FAIL |
| Module Completeness | PASS/FAIL |
| Cross-Module Consistency | PASS/FAIL |
| Dependency Direction | PASS/FAIL |
| Naming Conventions | PASS/FAIL |
| Documentation Coherence | PASS/FAIL |
| Build & Test | PASS/FAIL |

**Issues Found**: <count>
<list of structural issues>

---

**Overall**: ✅ APPROVED / ❌ CHANGES REQUESTED

<summary recommendation>
```

### Post as PR Comment

```bash
gh pr comment <number> --body "$(cat <<'EOF'
<combined report content>
EOF
)"
```

### Cleanup

```bash
# Return to original branch
git checkout <original-branch>
```

Report to user:

```
✔ PR #<number> reviewed
  QA:       <PASS/FAIL> (<N> issues)
  Guardian: <PASS/FAIL> (<N> issues)
  Comment:  Posted to PR #<number>
  URL:      <PR URL>
```
